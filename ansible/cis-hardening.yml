---
### Ensure the system is up-to-date ###

# CIS 3.2, 3.4: Ensure system software is up-to-date
- name: Update all packages on RHEL
  yum:
    name: "*"
    state: latest
  when: rhel

# CIS 1.1.1.5, 1.1.1.6: Ensure package updates are applied
- name: Update all packages on Ubuntu
  apt:
    update_cache: yes
    upgrade: dist
    autoremove: yes
  when: ubuntu

### Disable Unused Filesystems ###

# CIS 1.1.1.1: Disable cramfs
- name: Ensure mounting of cramfs is disabled
  lineinfile:
    path: /etc/modprobe.d/CIS.conf
    regexp: "^install cramfs"
    line: "install cramfs /bin/true"
    create: yes

# CIS 1.1.1.7: Disable freevxfs
- name: Ensure mounting of freevxfs is disabled
  lineinfile:
    path: /etc/modprobe.d/CIS.conf
    regexp: "^install freevxfs"
    line: "install freevxfs /bin/true"
    create: yes

# CIS 1.1.1.8: Disable squashfs
- name: Ensure mounting of squashfs is disabled
  lineinfile:
    path: /etc/modprobe.d/CIS.conf
    regexp: "^install squashfs"
    line: "install squashfs /bin/true"
    create: yes

# CIS 1.1.1.9: Disable udf
- name: Ensure mounting of udf is disabled
  lineinfile:
    path: /etc/modprobe.d/CIS.conf
    regexp: "^install udf"
    line: "install udf /bin/true"
    create: yes

# CIS 1.1.1.10: Disable hfs
- name: Ensure mounting of hfs is disabled
  lineinfile:
    path: /etc/modprobe.d/CIS.conf
    regexp: "^install hfs"
    line: "install hfs /bin/true"
    create: yes

# CIS 1.1.1.11: Disable hfs+
- name: Ensure mounting of hfsplus is disabled
  lineinfile:
    path: /etc/modprobe.d/CIS.conf
    regexp: "^install hfsplus"
    line: "install hfsplus /bin/true"
    create: yes

### Secure Boot Configuration ### 

# CIS 1.5.1: Set permissions on grub2 configuration file (RHEL)
- name: Set permissions on /boot/grub2/grub.cfg (RHEL)
  file:
    path: /boot/grub2/grub.cfg
    owner: root
    group: root
    mode: '0600'
  when: rhel

# CIS 1.5.2: Set permissions on grub2 configuration file (Ubuntu)
- name: Set permissions on /boot/grub/grub.cfg (Ubuntu)
  file:
    path: /boot/grub/grub.cfg
    owner: root
    group: root
    mode: '0600'
  when: ubuntu

### Enable and Configure auditd ###

# CIS 4.1.1.1: Ensure auditd is installed
- name: Install auditd on RHEL
  yum:
    name: audit
    state: present
  when: rhel

# CIS 4.1.1.1: Ensure auditd is installed
- name: Install auditd on Ubuntu
  apt:
    name: auditd
    state: present
  when: ubuntu

# CIS 4.1.1.3: Ensure auditd service is running
- name: Ensure auditd service is enabled and running
  service:
    name: auditd
    state: started
    enabled: yes

# CIS 4.1.3: Configure audit rules for identity access and logging
- name: Configure audit rules
  copy:
    dest: /etc/audit/rules.d/CIS.rules
    content: |
      -w /etc/passwd -p wa -k identity
      -w /etc/group -p wa -k identity
      -w /etc/shadow -p wa -k identity
      -w /etc/gshadow -p wa -k identity
      -w /etc/sudoers -p wa -k actions
      -w /var/log/lastlog -p wa -k logins
      -e 2
  notify:
    - Restart auditd

- name: Restart auditd
  service:
    name: auditd
    state: restarted

### Critical File Permissions ###

# CIS 6.1.2: Ensure proper permissions on /etc/passwd
- name: Ensure /etc/passwd permissions are set to 644
  file:
    path: /etc/passwd
    owner: root
    group: root
    mode: '0644'

# CIS 6.1.3: Ensure permissions on /etc/shadow
- name: Ensure /etc/shadow permissions are set to 600
  file:
    path: /etc/shadow
    owner: root
    group: root
    mode: '0600'

# CIS 6.1.4: Ensure proper permissions on /etc/group
- name: Ensure /etc/group permissions are set to 644
  file:
    path: /etc/group
    owner: root
    group: root
    mode: '0644'

# CIS 6.1.5: Ensure permissions on /etc/gshadow
- name: Ensure /etc/gshadow permissions are set to 600
  file:
    path: /etc/gshadow
    owner: root
    group: root
    mode: '0600'

### Disable Unused Services ###

# CIS 2.2.2: Ensure telnet client is not installed
- name: Disable telnet service
  service:
    name: telnet
    state: stopped
    enabled: no

# CIS 2.2.14: Disable rsync if not required
- name: Disable rsync service
  service:
    name: rsync
    state: stopped
    enabled: no

# CIS 2.2.3: Disable xinetd
- name: Disable xinetd service
  service:
    name: xinetd
    state: stopped
    enabled: no

### Ensure appropriate firewall rules are configured ###

# CIS 3.6: Ensure firewall is installed and enabled (RHEL)
- name: Install firewalld on RHEL
  yum:
    name: firewalld
    state: present
  when: rhel
  
# CIS 3.6: Ensure firewall is installed and enabled (Ubuntu)
- name: Install ufw on Ubuntu
  apt:
    name: ufw
    state: present
  when: ubuntu

# CIS 3.5.1.6: Ensure SSH is configured in firewall
- name: Configure firewalld on RHEL
  firewalld:
    zone: public
    service: ssh
    state: enabled
  when: rhel

# CIS 3.5.1.6: Ensure SSH is configured in firewall
- name: Configure ufw rules on Ubuntu
  ufw:
    rule: allow
    port: 22
    proto: tcp
  when: ubuntu

# CIS 3.5.1.7: Ensure the firewall service is enabled
- name: Enable the firewall service
  service:
    name: "{{ 'firewalld' if rhel else 'ufw' }}"
    state: started
    enabled: yes

### Password - Ensure strong password policies ###

# CIS 5.3.1: Ensure password creation requirements are configured
- name: Configure password policies on RHEL and Ubuntu
  copy:
    dest: /etc/security/pwquality.conf
    content: |
      minlen = 14
      minclass = 4

### Additional CIS Hardening Features ###

# CIS 5.4.4: Ensure default umask is configured
- name: Ensure default umask is set for all users
  lineinfile:
    path: /etc/profile
    regexp: "^umask"
    line: "umask 027"

# CIS 1.6.1.1: Disable core dumps
- name: Ensure core dumps are restricted
  lineinfile:
    path: /etc/security/limits.conf
    line: "* hard core 0"
    create: yes

# CIS 4.2.1.3: Configure /var/log/audit permissions
- name: Ensure permissions on /var/log/audit are configured
  file:
    path: /var/log/audit
    state: directory
    owner: root
    group: root
    mode: '0700'

# CIS 3.2.5: Disable IP forwarding
- name: Ensure IP masquerading is disabled
  lineinfile:
    path: /etc/sysctl.conf
    regexp: "^net.ipv4.ip_forward"
    line: "net.ipv4.ip_forward = 0"